import{_ as S}from"./AuthenticatedLayout.e202d503.js";import{D as m,o as p,g as _,a as f,w as y,F as x,d as e,x as N,t as g,k as w}from"./app.df7a48ba.js";import{e as C}from"./vue-basic-alert.esm.a6fa098a.js";import{m as v}from"./mqtt.min.77c8ccfe.js";import{_ as q}from"./_plugin-vue_export-helper.cdc0426e.js";import"./ApplicationLogo.13c20baa.js";const A={components:{BreezeAuthenticatedLayout:S,VueBasicAlert:C},data(){return{suggests:[],connection:{protocol:"ws",host:"demo.dkproject.store",port:9001,endpoint:"",clean:!0,connectTimeout:30*1e3,reconnectPeriod:4e3,clientId:"emqx_vue_"+Math.random().toString(16).substring(2,8),username:"danielkeung",password:"danielkeung123"},subscription:{topic:"table/request",qos:0},subscription2:{topic:"table/status",qos:0},publish:{topic:"table/request",qos:0,payload:'{ "msg": "test" }'},publish2:{topic:"table/status",qos:0,payload:'{ "msg": "test" }'},receiveNews:"",qosList:[0,1,2],client:{connected:!1},subscribeSuccess:!1,connecting:!1,retryTimes:0}},created(){this.getSuggest()},unmounted(){console.log("unmounted"),this.doUnSubscribe(this.subscription),this.doUnSubscribe(this.subscription2)},mounted(){console.log("mounted"),this.initData(),this.createConnection(),this.doSubscribe(this.subscription),this.doSubscribe(this.subscription2)},methods:{getSuggest(t=!1){this.suggests=[],axios.get("/getSuggest").then(o=>{for(let s=0;s<o.data.suggests.length;s++)axios.post("/getTableById",{table_id:o.data.suggests[s].table_id}).then(i=>{for(let n=0;n<i.data.tables.length;n++)this.suggests.push({suggest_id:o.data.suggests[s].suggest_id,no_of_ppl:o.data.suggests[s].no_of_ppl,status:o.data.suggests[s].status,rest_id:i.data.tables[n].rest_id,table_no:i.data.tables[n].table_no,capacity:i.data.tables[n].capacity,table_x:i.data.tables[n].table_x,table_y:i.data.tables[n].table_y,robot_id:i.data.tables[n].robot_id,table_id:o.data.suggests[s].table_id})})})},initData(){this.client={connected:!1},this.retryTimes=0,this.connecting=!1,this.subscribeSuccess=!1},handleOnReConnect(){if(this.retryTimes+=1,this.retryTimes>5)try{this.client.end(),this.initData(),this.$message.error("Connection maxReconnectTimes limit, stop retry")}catch(t){this.$message.error(t.toString())}},createConnection(){try{this.connecting=!0;const{protocol:t,host:o,port:s,endpoint:i,...n}=this.connection,r=`${t}://${o}:${s}${i}`;this.client=v.exports.connect(r,n),this.client.on&&(this.client.on("connect",()=>{this.connecting=!1,this.client.connected=!0,console.log("Connection succeeded!")}),this.client.on("reconnect",this.handleOnReConnect),this.client.on("error",c=>{console.log("Connection failed",c)}),this.client.on("message",(c,d)=>{this.receiveNews="",this.receiveNews=JSON.parse(this.receiveNews.concat(d)),c=="table/request"&&(console.log(`Received message2 ${d} from topic ${c}`),setTimeout(()=>this.getSuggest(!0),1500)),c=="table/status"&&this.receiveNews.status=="ACTIVE"&&setTimeout(()=>this.getSuggest(),1200)}))}catch(t){this.connecting=!1,console.log("createConnection error"),this.handleOnReConnect(),console.log("mqtt.connect error",t)}},doPublish(t,o,s,i){console.log("test do publish"),console.log(t),console.log(o),console.log(s),console.log(i);let n='{ "re_no":"'+t+'","status":"'+s+'","table_no":"'+i+'"}';const{topic:r,qos:c,payload:d}=this.publish;this.client.publish(o,n,{qos:c},u=>{u&&console.log("Publish error",u)})},doSubscribe(t){const{topic:o,qos:s}=t;this.client.subscribe(o,{qos:s},(i,n)=>{if(i){console.log("Subscribe to topics error",i);return}this.subscribeSuccess=!0,console.log("Subscribe to topics res",n)})},doUnSubscribe(t){const{topic:o}=t;console.log("doUnSubscribe"),this.client.unsubscribe(o,s=>{s&&console.log("Unsubscribe error",s)})},destroyConnection(){if(this.client.connected)try{this.client.end(!1,()=>{this.initData(),console.log("Successfully disconnected!")})}catch(t){console.log("Disconnect failed",t.toString())}},updateStatus(t,o){if(console.log("delete suggest_id"),console.log(t),!this.msg){let s=0,i="",n="",r="",c="",d="",u="",l="";for(let a=0;a<this.suggests.length;a++)(this.suggests[a].suggest_id=t)&&(s=this.suggests[a].no_of_ppl,i=this.suggests[a].table_id,n=this.suggests[a].rest_id,r=this.suggests[a].table_no,c=this.suggests[a].capacity,d=this.suggests[a].table_x,u=this.suggests[a].table_y,l=this.suggests[a].robot_id);axios.post("/updateStatus",{suggest_id:t,no_of_ppl:s,status:o,table_id:i}).then(a=>{this.getSuggest(),this.$refs.alert.showAlert("success",a.data.message+o,"success!","Success 200");let b=-1;for(let h=0;h<this.suggests.length;h++)this.suggests[h].suggest_id==t&&(b=b+1);b>-1&&this.suggests.splice(b,1),o=="APPROVED"&&axios.post("/updateStatusById",{table_id:i,table_no:r,rest_id:n,capacity:c,table_x:d,table_y:u,status:"INACTIVE",robot_id:l}).then(h=>{this.doPublish(t.toString(),"table/response","READY",r),console.log(h)})})}}}},T=e("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"}," Tables Arrangement ",-1),$={class:"py-12"},k={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},D={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},I={class:"p-6 bg-white border-b border-gray-200"},E={className:"table-fixed w-full"},R=e("thead",null,[e("tr",{className:"bg-gray-100"},[e("th",{className:"px-4 py-2 w-20"},"suggest id"),e("th",{className:"px-4 py-2"},"restaurant name"),e("th",{className:"px-4 py-2"},"table name"),e("th",{className:"px-4 py-2"},"number of people"),e("th",{className:"px-4 py-2"},"capacity"),e("th",{className:"px-4 py-2"},"Action")])],-1),B={className:"border px-4 py-2"},P={className:"border px-4 py-2"},V={className:"border px-4 py-2"},O={className:"border px-4 py-2"},U={className:"border px-4 py-2"},L={className:"border px-4 py-2"},j=["onClick"],z=["onClick"];function F(t,o,s,i,n,r){const c=m("Head"),d=m("vue-basic-alert"),u=m("BreezeAuthenticatedLayout");return p(),_(x,null,[f(c,{title:"tableViews"}),f(u,null,{header:y(()=>[T]),default:y(()=>[f(d,{duration:1500,closeIn:2500,ref:"alert"},null,512),e("div",$,[e("div",k,[e("div",D,[e("div",I,[e("table",E,[R,e("tbody",null,[(p(!0),_(x,null,N(n.suggests,l=>(p(),_("tr",null,[e("td",B,g(l.suggest_id),1),e("td",P,g(l.rest_id),1),e("td",V,g(l.table_no),1),e("td",O,g(l.no_of_ppl),1),e("td",U,g(l.capacity),1),e("td",L,[l.status=="PENDING"?(p(),_("button",{key:0,onClick:a=>r.updateStatus(l.suggest_id,"APPROVED"),tabIndex:"-1",type:"button",className:"px-4 py-2 text-sm text-white bg-blue-500 rounded"}," Approve ",8,j)):w("",!0),e("button",{onClick:a=>r.updateStatus(l.suggest_id,"REJECTED"),tabIndex:"-1",type:"button",className:"mx-1 px-4 py-2 text-sm text-white bg-red-500 rounded"}," Reject ",8,z)])]))),256))])])])])])])]),_:1})],64)}const Q=q(A,[["render",F]]);export{Q as default};
